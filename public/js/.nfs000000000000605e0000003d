(function ($) {
  'use strict';

  // Constants for easier modification and clearer references
  const eilatModeCookieName = 'eilatMode';
  const eilatShippingMethod = local_pickup;
  const regularShippingMethod = 'free_shipping:4';

  // Global variable to track the last shipping method
  let lastShippingMethod;

  // Initialize once the document is ready
  $(document).ready(function () {
    lastShippingMethod = $('select#shipping_method_0').val();
    initializeCheckout();
  });

  function initializeCheckout() {
    setupEventListeners();
    applyInitialSettings();
  }

  function setupEventListeners() {
    $(document.body).on('updated_checkout', updateCheckout);
    $(document.body).on(
      'change',
      'select#shipping_method_0',
      handleShippingMethodChange
    );
    $(document.body).on(
      'click',
      'a.woocommerce-terms-and-conditions-link',
      function (e) {
        if (getCookie(eilatModeCookieName) === 'true') {
          e.preventDefault();
          $('a.woocommerce-terms-and-conditions-link').attr(
            'href',
            'https://lego.certifiedstore.co.il/eis-eilat/'
          );
        }
      }
    );
  }

  function applyInitialSettings() {
    const isEilatMode = getCookie(eilatModeCookieName) === 'true';
    toggleEilatMode(isEilatMode);
  }

  function updateCheckout() {
    const placeOrderText =
      getCookie(eilatModeCookieName) === 'true' ? 'הזמנה באילת' : 'המשך לתשלום';
    $('button#place_order').text(placeOrderText);

    // Ensure we have a fallback for lastShippingMethod
    const fallbackShippingMethod = lastShippingMethod || regularShippingMethod;

    $('#shipping_method_0').val(
      getCookie(eilatModeCookieName) === 'true'
        ? local_pickup
        : fallbackShippingMethod
    );
  }

  function toggleEilatMode(enable) {
    if (enable) {
      lastShippingMethod = $('select#shipping_method_0').val(); // Save the current method before changing
      toggleCoupon(true);
      $('#payment_method_cod').prop('checked', true).trigger('change');
      $('#billing_city').val('אילת');
      $('#billing_state').val('IL2600').trigger('change');
      toggleBillingFields(false);
      toggleExtraFields(false);
      toggleBillingTitle(false);
      termsLink(true);
      setTimeout(() => {
        $('#shipping_method_0').val(local_pickup).trigger('change');
      }, 2000);
    } else {
      $('#payment_method_cod').prop('checked', false).trigger('change');
      toggleCoupon(false);
      $('#billing_city').val('');
      $('#billing_state').val('').trigger('change');
      toggleBillingFields(true);
      toggleExtraFields(true);
      toggleBillingTitle(true);
      $('.woocommerce-billing-fields h3').text('פרטי חיוב');
      termsLink(false);
      setTimeout(() => {
        const fallbackShippingMethod = lastShippingMethod || regularShippingMethod;
        $('#shipping_method_0').val(fallbackShippingMethod).trigger('change');
      }, 2000);
    }
  }

  function toggleBillingFields(display) {
    const fields = [
      '#billing_address_1_field',
      '#billing_address_2_field',
      'p#billing_address_3_field',
      '#billing_city_field',
      '#billing_state_field',
      '#billing_postcode_field',
    ];
    fields.forEach((field) => $(field).toggle(display));
    $('#billing_state').select2();
    $('span.optional').hide();
    fields.forEach((field) => {
      const label = $(field + ' label');
      if (label.find('abbr.required').length === 0) {
        label.append('<abbr class="required" title="נדרש">*</abbr>');
      }
    });
  }

  function toggleExtraFields(display) {
    var coupon = $('.woocommerce-form-coupon-toggle');
    var deliveryDetails = $('#custom_delivery_details');
    var eilatBanner = $('.eilat-banner');
    coupon.toggle(display);
    deliveryDetails.toggle(!display);
    eilatBanner.hide();
  }

  function toggleBillingTitle(display) {
    var title = $('.woocommerce-billing-fields h3');
    if (display) {
      title.text('פרטי חיוב');
    } else {
      title.text('פרטי הזמנה');
    }
  }

  function handleShippingMethodChange() {
    const selectedShippingMethod = $(this).val();
    const isEilatMode = selectedShippingMethod === local_pickup;

    // Store the last non-eilat shipping method for restoration later
    if (!isEilatMode && selectedShippingMethod !== local_pickup) {
      lastShippingMethod = selectedShippingMethod;
    }

    setCookie(eilatModeCookieName, isEilatMode ? 'true' : 'false', 1);
    toggleBillingFields(!isEilatMode);
    toggleExtraFields(!isEilatMode);
    toggleBillingTitle(!isEilatMode);
    termsLink(isEilatMode);
    toggleEilatBanner(isEilatMode);
    toggleCoupon(isEilatMode);
    
    // Only check stock when switching TO Eilat mode (local pickup)
    if (isEilatMode) {
      checkStock(true);
    }
  }

  function checkStock(isEilat) {
    $.ajax({
      type: 'POST',
      url: eilat_rest_api.rest_url + 'eilat/v1/check-stock',
      beforeSend: function (xhr) {
        xhr.setRequestHeader('X-WP-Nonce', eilat_rest_api.nonce);
      },
      data: { eilatMode: isEilat },
      success: function (response) {
        if (!response.success) {
          handleStockError(response.data);
        }
      },
      error: function () {
        Swal.fire({
          icon: 'error',
          title: 'טעות תקשורת',
          text: 'נראה שיש בעיה בבקשה לשרת. נסה שוב מאוחר יותר.',
          confirmButtonText: 'סגור',
        });
      },
    });
  }

  function handleStockError(errorMessage) {
    Swal.fire({
      icon: 'error',
      title: errorMessage || 'אין מלאי לפריטים בעגלה',
      confirmButtonText: 'ריקון עגלה',
      cancelButtonText: 'מעבר לעגלה',
      showCancelButton: true,
    }).then((result) => {
      if (result.isConfirmed) {
        clearCart();
      } else {
        location.href = '/cart';
      }
    });
  }

  function clearCart() {
    $.ajax({
      type: 'POST',
      url: eilat_rest_api.rest_url + 'eilat/v1/clear-cart',
      beforeSend: function (xhr) {
        xhr.setRequestHeader('X-WP-Nonce', eilat_rest_api.nonce);
      },
      success: function () {
        Swal.fire({
          icon: 'success',
          title: 'העגלה רוקנה בהצלחה',
          timer: 1500,
        }).then(() => {
          window.location.href = '/';
        });
      },
    });
  }

  function toggleCoupon(isEilat) {
    if (isEilat) {
      $('.woocommerce-form-coupon-toggle').hide();
      $.ajax({
        type: 'POST',
        url: eilat_rest_api.rest_url + 'eilat/v1/remove-coupon',
        beforeSend: function (xhr) {
          xhr.setRequestHeader('X-WP-Nonce', eilat_rest_api.nonce);
        },
      });
    } else {
      $('.woocommerce-form-coupon-toggle').show();
    }
  }

  function termsLink(isEilat) {
    if (isEilat) {
      $('a.woocommerce-terms-and-conditions-link').attr(
        'href',
        'https://lego.certifiedstore.co.il/eis-eilat/'
      );
    }
  }
})(jQuery);
